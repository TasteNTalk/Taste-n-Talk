import React, { useState, useEffect, useRef } from 'react';

const RecipeVideoSlider = () => {
  const [videoData, setVideoData] = useState([]);
  const [currentIndex, setCurrentIndex] = useState(0);
  const [cardsPerView, setCardsPerView] = useState(0);
  const sliderWrapperRef = useRef(null);
  const sliderRef = useRef(null);

  useEffect(() => {
    fetchRecipeVideos();
    
    // Handle window resize
    const handleResize = () => {
      if (sliderRef.current) {
        const cardWidth = 300 + 20; // card width + gap
        setCardsPerView(Math.floor(sliderRef.current.offsetWidth / cardWidth));
      }
    };

    window.addEventListener('resize', handleResize);
    
    // Call once to initialize
    handleResize();
    
    return () => {
      window.removeEventListener('resize', handleResize);
    };
  }, []);

  useEffect(() => {
    updateSliderPosition();
  }, [currentIndex, videoData]);

  const fetchRecipeVideos = async () => {
    const API_KEY = "YOUR_YOUTUBE_API_KEY";
    const CHANNEL_ID = "YOUR_CHANNEL_ID";

    try {
      const response = await fetch(
        `https://www.googleapis.com/youtube/v3/search?key=${API_KEY}&channelId=${CHANNEL_ID}&part=snippet,id&order=date&type=video&maxResults=10`
      );
      const data = await response.json();
      
      if (data.items && data.items.length > 0) {
        setVideoData(data.items);
      } else {
        addFallbackContent();
      }
    } catch (error) {
      console.error("Error fetching YouTube videos:", error);
      addFallbackContent();
    }
  };

  const addFallbackContent = () => {
    const fallbackData = [];
    
    for (let i = 0; i < 4; i++) {
      fallbackData.push({
        snippet: {
          title: `Delicious Recipe ${i + 1}`,
          description: "Sample recipe description that shows when API is unavailable.",
          thumbnails: { high: { url: "" } },
        },
        id: { videoId: "" },
      });
    }
    
    setVideoData(fallbackData);
  };

  const updateSliderPosition = () => {
    if (sliderWrapperRef.current) {
      const cardWidth = 300 + 20; // card width + gap
      const offset = -currentIndex * cardWidth;
      sliderWrapperRef.current.style.transform = `translateX(${offset}px)`;
    }
  };

  const slideNext = () => {
    if (currentIndex >= videoData.length) {
      // If we reach the midpoint, reset to beginning without animation
      setCurrentIndex(0);
      if (sliderWrapperRef.current) {
        sliderWrapperRef.current.style.transition = "none";
        
        // Force reflow
        sliderWrapperRef.current.offsetHeight;
        
        // Restore transition
        setTimeout(() => {
          if (sliderWrapperRef.current) {
            sliderWrapperRef.current.style.transition = "transform 0.5s ease";
          }
        }, 10);
      }
    } else {
      setCurrentIndex(prevIndex => prevIndex + 1);
    }
  };

  const slidePrev = () => {
    if (currentIndex <= 0) {
      // If we go before first slide, jump to end of first set
      setCurrentIndex(videoData.length - 1);
      if (sliderWrapperRef.current) {
        sliderWrapperRef.current.style.transition = "none";
        
        // Force reflow
        sliderWrapperRef.current.offsetHeight;
        
        // Restore transition
        setTimeout(() => {
          if (sliderWrapperRef.current) {
            sliderWrapperRef.current.style.transition = "transform 0.5s ease";
          }
        }, 10);
      }
    } else {
      setCurrentIndex(prevIndex => prevIndex - 1);
    }
  };

  // Optional: Start automatic sliding
  // useEffect(() => {
  //   const interval = setInterval(() => {
  //     slideNext();
  //   }, 5000);
  //   
  //   return () => clearInterval(interval);
  // }, [videoData, currentIndex]);

  const renderVideoCard = (video, index) => (
    <div className="recipe-video-card" key={`video-${index}`}>
      {video.snippet.thumbnails?.high?.url ? (
        <img 
          src={video.snippet.thumbnails.high.url} 
          alt={video.snippet.title} 
          className="video-thumbnail"
        />
      ) : (
        <div 
          className="video-thumbnail" 
          style={{
            height: 200, 
            backgroundColor: "#f0f0f0", 
            display: "flex", 
            alignItems: "center", 
            justifyContent: "center"
          }}
        >
          <span style={{ fontSize: "2rem", color: "#aaa" }}>üç≥</span>
        </div>
      )}
      <div className="video-details">
        <h3 style={{ fontWeight: "bold", fontSize: "1.125rem" }}>
          {video.snippet.title}
        </h3>
        <p style={{ fontSize: "0.875rem", color: "#666" }}>
          {video.snippet.description.substring(0, 100)}...
        </p>
        <button 
          onClick={() => {
            if (video.id?.videoId) {
              window.open(`https://www.youtube.com/watch?v=${video.id.videoId}`, '_blank');
            }
          }}
          style={{ 
            marginTop: "0.5rem", 
            backgroundColor: "#002140", 
            color: "white", 
            padding: "0.25rem 0.75rem", 
            borderRadius: "9999px", 
            border: "none", 
            cursor: "pointer" 
          }}
        >
          Watch Recipe
        </button>
      </div>
    </div>
  );

  return (
    <div className="recipe-video-container">
      <div className="recipe-video-slider" ref={sliderRef}>
        <div 
          className="slider-wrapper" 
          ref={sliderWrapperRef}
          style={{ 
            display: "flex", 
            gap: "20px", 
            transition: "transform 0.5s ease" 
          }}
        >
          {/* Create double set of cards for infinite loop effect */}
          {[...videoData, ...videoData].map((video, index) => (
            renderVideoCard(video, index)
          ))}
        </div>
      </div>
      
      <button 
        className="prev-arrow"
        onClick={slidePrev}
        style={{ 
          position: "absolute", 
          left: "10px", 
          top: "50%", 
          transform: "translateY(-50%)",
          zIndex: 10
        }}
      >
        &#10094;
      </button>
      
      <button 
        className="next-arrow"
        onClick={slideNext}
        style={{ 
          position: "absolute", 
          right: "10px", 
          top: "50%", 
          transform: "translateY(-50%)",
          zIndex: 10  
        }}
      >
        &#10095;
      </button>
    </div>
  );
};

export default RecipeVideoSlider;

// css part 

      .recipe-video-container {
  position: relative;
  width: 100%;
  overflow: hidden;
}

.recipe-video-slider {
  width: 100%;
  overflow: hidden;
  padding: 20px 0;
}

.recipe-video-card {
  flex: 0 0 300px;
  border-radius: 8px;
  overflow: hidden;
  box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
  background-color: white;
}

.video-thumbnail {
  width: 100%;
  height: 200px;
  object-fit: cover;
}

.video-details {
  padding: 16px;
}

.prev-arrow, .next-arrow {
  background-color: rgba(255, 255, 255, 0.7);
  border: none;
  border-radius: 50%;
  width: 40px;
  height: 40px;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  font-size: 20px;
}
